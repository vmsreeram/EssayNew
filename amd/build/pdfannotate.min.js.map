{"version":3,"file":"pdfannotate.min.js","sources":["../src/pdfannotate.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * OnClick handlers are defined here\n * These functions will call functions in pdfannotate.js.\n *\n * @subpackage essayannotate\n * @copyright  2024 IIT Palakkad\n * @copyright  based on work done by Ravisha Hesh {@link https://github.com/RavishaHesh/PDFJsAnnotations/tree/master}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * PDFAnnotate v1.0.1\n * Author: Ravisha Heshan\n */\n\n /**\n * @updatedby Asha Jose and Parvathy S Kumar\n * SerializePDF and SavePDF functions are modified.\n */\n\nimport fabric from 'qtype_essayannotate/fabric';\nimport pdfjsLib from 'qtype_essayannotate/pdf';\nimport $ from 'jquery';\n\nvar contextid,attemptid,filename,usageid,slot;\nexport var PDFAnnotate = function(container_id, url, options = {}) {\n    this.number_of_pages = 0;\n    this.pages_rendered = 0;\n    this.active_tool = 1; // 1 - Free hand, 2 - Text, 3 - Arrow, 4 - Rectangle\n    this.fabricObjects = [];\n    this.fabricObjectsData = [];\n    this.color = 'rgb(0,0,0)';\n    this.borderColor = 'rgb(0,0,0)';\n    this.borderSize = 1;\n    this.font_size = 16;\n    this.active_canvas = 0;\n    this.container_id = container_id;\n    this.url = url;\n    this.pageImageCompression = options.pageImageCompression\n    ? options.pageImageCompression.toUpperCase()\n    : \"NONE\";\n    this.textBoxText = 'Edit Text';\n    // this.format;\n    // this.orientation;\n    this.highlightBoxWidth=400;\n    this.highlightBoxHeight=50;\n    this.highlightBoxOpacity=0.3;\n    this.freeDrawingBrushWidth=2;\n    var inst = this;\n\n    var loadingTask = pdfjsLib.getDocument(this.url);\n    loadingTask.promise.then(function (pdf) {\n        var scale = options.scale ? options.scale : 1.3;\n        inst.number_of_pages = pdf.numPages;\n\n        for (var i = 1; i <= pdf.numPages; i++) {\n\n            pdf.getPage(i).then(function (page) {    //Creating canvas and rendering pages in the canvas\n                if (typeof inst.format === 'undefined' ||\n                typeof inst.orientation === 'undefined') {\n                    var originalViewport = page.getViewport({ scale: 1 });\n                    inst.format = [originalViewport.width, originalViewport.height];\n                    inst.orientation =\n                    originalViewport.width > originalViewport.height ?\n                        'landscape' :\n                        'portrait';\n                }\n\n                var viewport = page.getViewport({scale: scale});\n                var canvas = document.createElement('canvas');\n                document.getElementById(inst.container_id).appendChild(canvas);\n                canvas.className = 'pdf-canvas';\n                canvas.height = viewport.height;\n                canvas.width = viewport.width;\n\n                var context = canvas.getContext('2d');\n                var renderContext = {\n                    canvasContext: context,\n                    viewport: viewport\n                };\n                var renderTask = page.render(renderContext);\n\n                renderTask.promise.then(function () {\n                    $('.pdf-canvas').each(function (index, el) {\n                        $(el).attr('id', 'page-' + (index + 1) + '-canvas');\n                    });\n                    inst.pages_rendered++;\n                    if (inst.pages_rendered == inst.number_of_pages) //Calling initFabric() after rendering the entire pages\n                    {\n                        inst.initFabric();\n                    }\n                });\n            });\n        }\n    }, function (reason) { // eslint-disable-line no-unused-vars\n        // console.error(reason);\n    });\n\n    this.initFabric = function () {\n        var inst = this;\n        let canvases = $('#' + inst.container_id + ' canvas');\n        canvases.each(function (index, el) {\n            var background = el.toDataURL(\"image/png\");\n            var fabricObj = new fabric.Canvas(el.id, {});\n            inst.fabricObjects.push(fabricObj);\n            if (typeof options.onPageUpdated == 'function') {\n                fabricObj.on('object:added', function() {\n                    var oldValue = Object.assign({}, inst.fabricObjectsData[index]);\n                    inst.fabricObjectsData[index] = fabricObj.toJSON();\n                    options.onPageUpdated(index + 1, oldValue, inst.fabricObjectsData[index]);\n                });\n            }\n            fabricObj.setBackgroundImage(background, fabricObj.renderAll.bind(fabricObj));\n            $(fabricObj.upperCanvasEl).click(function (event) {\n                inst.active_canvas = index;\n                inst.fabricClickHandler(event, fabricObj);\n            });\n            fabricObj.on('after:render', function () {\n                inst.fabricObjectsData[index] = fabricObj.toJSON();\n                fabricObj.off('after:render');\n            });\n\n            if (index === canvases.length - 1 && typeof options.ready === 'function') {\n                options.ready();\n            }\n        });\n    };\n\n    this.fabricClickHandler = function (event, fabricObj) {\n        var inst = this;\n        var activeObject = inst.fabricObjects[inst.active_canvas].getActiveObject();\n        var toolObj;\n\n        if (inst.active_tool == 2) {    //Text Box\n          toolObj = new fabric.IText(inst.textBoxText, {\n            left: event.clientX - fabricObj.upperCanvasEl.getBoundingClientRect().left,\n            top: event.clientY - fabricObj.upperCanvasEl.getBoundingClientRect().top,\n            fill: inst.color,\n            fontSize: inst.font_size,\n            lockRotation: true,\n            lockScalingX: true,\n            lockScalingY: true\n          });\n        }\n        else if (inst.active_tool == 4) {    //Highlight Box\n          toolObj = new fabric.Rect({\n            left: event.clientX - fabricObj.upperCanvasEl.getBoundingClientRect().left,\n            top: event.clientY - fabricObj.upperCanvasEl.getBoundingClientRect().top,\n            width: inst.highlightBoxWidth,\n            height:  inst.highlightBoxHeight,\n            fill: inst.color,\n            opacity: inst.highlightBoxOpacity,\n            lockRotation: true\n          });\n        }\n        else if(inst.active_tool== 0) {    //Select\n              if(activeObject) {\n                //locking the rotation and scaling of free hand brush, if it is currently selected\n                if(activeObject.get('type')== 'path') {\n                activeObject.set({\n                    lockScalingX: true,\n                    lockScalingY: true,\n                    lockRotation: true});\n                }\n            }\n          }\n\n        //Change the current selected tool in the UI to Select if the active tool is highlight box or text\n        if (inst.active_tool == 2 || inst.active_tool == 4) {\n            var element = document.querySelector(\"#select\");\n            $(\".tool-button.active\").removeClass(\"active\");\n            $(element).addClass(\"active\");\n        }\n\n        //Change the currently active tool to Select\n        inst.active_tool = 0;\n        if (toolObj) {\n                fabricObj.add(toolObj);\n        }\n    };\n};\n\nPDFAnnotate.prototype.enableSelector = function () {\n    var inst = this;\n    inst.active_tool = 0;\n    if (inst.fabricObjects.length > 0) {\n        $.each(inst.fabricObjects, function (index, fabricObj) {\n            fabricObj.isDrawingMode = false;\n        });\n    }\n\n\n};\n\nPDFAnnotate.prototype.enablePencil = function () {\n    var inst = this;\n    inst.active_tool = 1;\n    if (inst.fabricObjects.length > 0) {\n        $.each(inst.fabricObjects, function (index, fabricObj) {\n            fabricObj.freeDrawingBrush.width=inst.freeDrawingBrushWidth;    //Changed default brush size\n            fabricObj.isDrawingMode = true;\n        });\n    }\n\n};\n\nPDFAnnotate.prototype.enableAddText = function () {\n    var inst = this;\n    inst.active_tool = 2;\n    if (inst.fabricObjects.length > 0) {\n        $.each(inst.fabricObjects, function (index, fabricObj) {\n            fabricObj.isDrawingMode = false;\n        });\n    }\n\n};\n\nPDFAnnotate.prototype.enableRectangle = function () {\n    var inst = this;\n    inst.active_tool = 4;\n    if (inst.fabricObjects.length > 0) {\n        $.each(inst.fabricObjects, function (index, fabricObj) {\n            fabricObj.isDrawingMode = false;\n        });\n    }\n};\n\nPDFAnnotate.prototype.deleteSelectedObject = function () {\n    var inst = this;\n    var activeObject = inst.fabricObjects[inst.active_canvas].getActiveObject();\n    if (activeObject)\n    {\n        if (confirm('Are you sure ?'))\n        {\n            inst.fabricObjects[inst.active_canvas].remove(activeObject);\n        }\n    }\n};\n\n//Updated by Asha Jose and Parvathy S Kumar\n  PDFAnnotate.prototype.savePdf = function () {\n    //Calling the serializePdf function\n    this.serializePdf(function (string) {\n      var value = JSON.stringify(JSON.parse(string), null, 4);\n\n      var xmlhttp = new XMLHttpRequest();    //Creating an HTTP request instance\n      xmlhttp.open(\"POST\", \"upload.php\", true);\n      xmlhttp.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n      xmlhttp.onreadystatechange = function() {\n\n        //Getting the response once upload.php finishes execution\n        //readyState will become 4 if the execution finishes\n        if (this.status == 200 && this.readyState == 4) {\n            showMessage(\"file has been saved\");\n        } else if (this.status != 200 && this.readyState == 4) {\n            showMessage(\"Not able to save the file\");\n        }\n\n        /**\n         * Displays a message box with the given message.\n         *\n         * @param {string} message - The message to be displayed.\n         */\n        function showMessage(message) {\n            // Create a message box\n            var messageBox = document.createElement(\"div\");\n            messageBox.innerHTML = \"<p>\" + message + \"</p>\";\n\n            // Style the message box\n            messageBox.style.position = \"fixed\";\n            messageBox.style.top = \"50%\";\n            messageBox.style.left = \"50%\";\n            messageBox.style.transform = \"translate(-50%, -50%)\";\n            messageBox.style.backgroundColor = \"#4CAF50\";\n            messageBox.style.color = \"#fff\";\n            messageBox.style.padding = \"20px\";\n            messageBox.style.borderRadius = \"5px\";\n            messageBox.style.boxShadow = \"0 0 10px rgba(0, 0, 0, 0.3)\";\n            messageBox.style.transition = \"opacity 0.5s\";\n\n            // Append the message box to the body\n            document.body.appendChild(messageBox);\n\n            // Automatically remove the message box after 3 seconds\n            setTimeout(function () {\n                messageBox.style.opacity = \"0\";\n                setTimeout(function () {\n                    document.body.removeChild(messageBox);\n                    window.close();\n                    window.opener.location.reload();\n                }, 500); // Fade-out transition time\n            }, 1000); // Display time\n        }\n\n\n      };\n      //Sending data to upload.php\n      xmlhttp.send(\"id=\" + value + \"&contextid=\" + contextid + \"&attemptid=\"+attemptid\n      + \"&filename=\" + filename + \"&usageid=\" + usageid + \"&slot=\" + slot);\n    });\n};\n\n\n//Convert the Page Annotations to JSON data\nPDFAnnotate.prototype.serializePdf = function (callback) {\n    var inst = this;\n    var pageAnnotations=[];\n    //Initialising list of fabric objects for each page\n    //Length of fabricObjects is the number of pages\n    for (let i = 0; i < inst.fabricObjects.length; i++) {\n      pageAnnotations.push([]);\n    }\n\n    //The function is invoked for each page  to iterate through the annotations\n    inst.fabricObjects.forEach(function (fabricObject,index) {\n      fabricObject.clone(function (fabricObjectCopy) {\n        fabricObjectCopy.setBackgroundImage(null);\n        fabricObjectCopy.setBackgroundColor('');\n        if(fabricObjectCopy._objects.length !== 0)    //Checking if the page has any annotations\n        {\n            for(var j=0; j< fabricObjectCopy._objects.length ; j++)    //Iterate through the list of annotations\n              {\n                //Used to handle the translation of path object(free hand)\n                if(fabricObjectCopy._objects[j].get('type')== 'path')\n                {\n                    var pathObj = fabricObjectCopy._objects[j];\n                    var matrix=pathObj.calcTransformMatrix();\n                    var pointsList = pathObj.path;\n                    var length = Object.keys(pointsList).length;\n                    var offsetX=pathObj.pathOffset.x;\n                    var offsetY=pathObj.pathOffset.y;\n                    for(var i=0; i< length;i++)\n                    {\n                        var point1= new fabric.Point(pointsList[i][1],pointsList[i][2]);\n                        var newPoints1= fabric.util.transformPoint(point1, matrix);\n                        pointsList[i][1] = newPoints1.x - offsetX;\n                        pointsList[i][2] = newPoints1.y - offsetY;\n\n                        if(i!=0 && i!=length -1)\n                        //First and Last elements in the pointsList have only a single set of coordinate\n                        //All the other elements have 2 set of points\n                        {\n                            var point2= new fabric.Point(pointsList[i][3],pointsList[i][4]);\n                            var newPoints2= fabric.util.transformPoint(point2, matrix);\n                            pointsList[i][3] = newPoints2.x - offsetX;\n                            pointsList[i][4] = newPoints2.y - offsetY;\n                        }\n                    }\n                    //Copy transformed list of points to the path object\n                    fabricObjectCopy._objects[j].path=pointsList;\n                }\n              }\n\n            pageAnnotations[index].push(fabricObjectCopy);\n        }\n\n        if (index+1 === inst.fabricObjects.length) {\n          var data = {\n            page_setup: {\n              format: inst.format,\n              orientation: inst.orientation,\n            },\n            pages: pageAnnotations,\n          };\n          callback(JSON.stringify(data));    //The serialized data is converted to JSON\n        }\n      });\n    });\n  };\n//Updation ends\n\nPDFAnnotate.prototype.setColor = function (color) {\n    var inst = this;\n    inst.color = color;\n    $.each(inst.fabricObjects, function (index, fabricObj) {\n        fabricObj.freeDrawingBrush.color = color;\n    });\n};\n\nPDFAnnotate.prototype.setBorderColor = function (color) {\n    var inst = this;\n    inst.borderColor = color;\n};\n\nPDFAnnotate.prototype.setFontSize = function (size) {\n    this.font_size = size;\n};\n\n\n/**\n * Changes the active tool based on the event target.\n *\n * @param {Event} event - The event object.\n */\nfunction changeActiveTool(event) {\n    event.preventDefault();\n    var element = $(event.target).hasClass(\"tool-button\")\n    ? $(event.target)\n    : $(event.target).parents(\".tool-button\").first();\n    $(\".tool-button.active\").removeClass(\"active\");\n    $(element).addClass(\"active\");\n}\n\n/**\n * Enables the selector tool in the PDF.\n *\n * @param {Event} event - The event object.\n * @param {PDFAnnotate} pdf - The PDFAnnotate instance.\n */\nfunction enableSelector(event,pdf) {\n    event.preventDefault();\n    changeActiveTool(event);\n    pdf.enableSelector();\n}\n\n/**\n * Enables the pencil tool in the PDF.\n *\n * @param {Event} event - The event object.\n * @param {PDFAnnotate} pdf - The PDFAnnotate instance.\n */\nfunction enablePencil(event,pdf) {\n    event.preventDefault();\n    changeActiveTool(event);\n    pdf.enablePencil();\n}\n\n/**\n * Enables the add text tool in the PDF.\n *\n * @param {Event} event - The event object.\n * @param {PDFAnnotate} pdf - The PDFAnnotate instance.\n */\nfunction enableAddText(event,pdf) {\n    event.preventDefault();\n    changeActiveTool(event);\n    pdf.enableAddText();\n}\n\n/**\n * Enables the rectangle tool in the PDF.\n *\n * @param {Event} event - The event object.\n * @param {PDFAnnotate} pdf - The PDFAnnotate instance.\n */\nfunction enableRectangle(event,pdf) {\n    event.preventDefault();\n    changeActiveTool(event);\n    pdf.enableRectangle();\n}\n\n/**\n * Deletes the selected object in the PDF.\n *\n * @param {Event} event - The event object.\n * @param {PDFAnnotate} pdf - The PDFAnnotate instance.\n */\nfunction deleteSelectedObject(event,pdf) {\n    event.preventDefault();\n    pdf.deleteSelectedObject();\n}\n\n/**\n * Saves the PDF.\n *\n * @param {Event} event - The event object.\n * @param {PDFAnnotate} pdf - The PDFAnnotate instance.\n */\nfunction savePDF(event,pdf) {\n    event.preventDefault();\n    pdf.savePdf();        //Changes made by Asha and Parvathy: Removed a parameter of the function\n}\n\n\n\nexport const init =(contextId,attemptId,fileName,usageId,sloT,fileurl) =>{\n    // eslint-disable-next-line no-console\n    window.console.log(\"pdfAnnotate :: Init\");\n\n    window.alert(\"sometext pdfAnnotate\");\n\n    contextid=contextId;\n    attemptid=attemptId;\n    filename=fileName;\n    usageid=usageId;\n    slot=sloT;\n    window.console.log(contextid);\n    window.console.log(attemptid);\n    window.console.log(filename);\n    window.console.log(slot);\n    window.console.log(usageid);\n\n\n    window.console.log(\"ClickHandler :: Init\");\n\n    window.alert(\"sometext clickhandler\");\n    window.console.log(PDFAnnotate);\n    window.console.log(fabric);\n    window.console.log(pdfjsLib);\n    var pdf = new PDFAnnotate(\"pdf-container\", fileurl, {\n        onPageUpdated(page, oldData, newData) { // eslint-disable-line no-unused-vars\n        },\n        ready() {\n        },\n        scale: 1.5,\n        pageImageCompression: \"SLOW\", // FAST, MEDIUM, SLOW(Helps to control the new PDF file size)\n    });\n    $(function () {\n        $('.color-tool').click(function () {\n            $('.color-tool.active').removeClass('active');\n            $(this).addClass('active');\n            var color = $(this).get(0).style.backgroundColor;\n            pdf.setColor(color);\n        });\n\n        $('#font-size').change(function () {\n            var font_size = $(this).val();\n            pdf.setFontSize(font_size);\n        });\n    });\n\n    const pencilButton = document.getElementById('pencil');\n    pencilButton.addEventListener('click', (event) => {\n        enablePencil(event,pdf);\n    });\n    const selectorButton = document.getElementById('select');\n    selectorButton.addEventListener('click', (event) => {\n        enableSelector(event,pdf);\n    });\n    const addTextButton = document.getElementById('text');\n    addTextButton.addEventListener('click', (event) => {\n        enableAddText(event,pdf);\n    });\n    const rectangleButton = document.getElementById('rectangle');\n    rectangleButton.addEventListener('click', (event) => {\n        enableRectangle(event,pdf);\n    });\n    const deleteButton = document.getElementById('deletebtn');\n    deleteButton.addEventListener('click', (event) => {\n        deleteSelectedObject(event,pdf);\n    });\n    const saveButton = document.getElementById('savebtn');\n    saveButton.addEventListener('click', (event) => {\n        savePDF(event,pdf);\n    });\n};"],"names":["_interopRequireDefault","obj","__esModule","default","contextid","attemptid","filename","usageid","slot","_fabric","_pdf","_jquery","PDFAnnotate","container_id","url","options","arguments","length","undefined","this","number_of_pages","pages_rendered","active_tool","fabricObjects","fabricObjectsData","color","borderColor","borderSize","font_size","active_canvas","pageImageCompression","toUpperCase","textBoxText","highlightBoxWidth","highlightBoxHeight","highlightBoxOpacity","freeDrawingBrushWidth","inst","pdfjsLib","getDocument","promise","then","pdf","scale","numPages","i","getPage","page","format","orientation","originalViewport","getViewport","width","height","viewport","canvas","document","createElement","getElementById","appendChild","className","renderContext","canvasContext","getContext","render","$","each","index","el","attr","initFabric","reason","canvases","background","toDataURL","fabricObj","fabric","Canvas","id","push","onPageUpdated","on","oldValue","Object","assign","toJSON","setBackgroundImage","renderAll","bind","upperCanvasEl","click","event","fabricClickHandler","off","ready","toolObj","activeObject","getActiveObject","IText","left","clientX","getBoundingClientRect","top","clientY","fill","fontSize","lockRotation","lockScalingX","lockScalingY","Rect","opacity","get","set","element","querySelector","removeClass","addClass","add","changeActiveTool","preventDefault","target","hasClass","parents","first","_exports","prototype","enableSelector","isDrawingMode","enablePencil","freeDrawingBrush","enableAddText","enableRectangle","deleteSelectedObject","confirm","remove","savePdf","serializePdf","string","value","JSON","stringify","parse","xmlhttp","XMLHttpRequest","open","setRequestHeader","onreadystatechange","showMessage","message","messageBox","innerHTML","style","position","transform","backgroundColor","padding","borderRadius","boxShadow","transition","body","setTimeout","removeChild","window","close","opener","location","reload","status","readyState","send","callback","pageAnnotations","forEach","fabricObject","clone","fabricObjectCopy","setBackgroundColor","_objects","j","pathObj","matrix","calcTransformMatrix","pointsList","path","keys","offsetX","pathOffset","x","offsetY","y","point1","Point","newPoints1","util","transformPoint","point2","newPoints2","data","page_setup","pages","setColor","setBorderColor","setFontSize","size","init","contextId","attemptId","fileName","usageId","sloT","fileurl","console","log","alert","oldData","newData","change","val","addEventListener","savePDF"],"mappings":"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"}